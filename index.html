<!DOCTYPE html>
<html>
<head>
    <title>F# Chess Server</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 1.5rem; border-radius: 8px; background: #f9f9f9; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        .btn-group { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; flex: 1; }
        .btn-join { background-color: #28a745; }
        .btn-move { background-color: #007bff; }
        button:hover { opacity: 0.9; }
        #log { margin-top: 20px; padding: 10px; background: #eee; border-left: 5px solid #333; }
        code { display: block; background: #333; color: #fff; padding: 10px; margin-top: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>♟️ F# Chess Server</h1>

    <div class="box">
        <h3>1. Join a Game</h3>
        <label>Game ID:</label>
        <input type="text" id="gameId" value="GameRoom1" />

        <label>Your Player Name:</label>
        <input type="text" id="playerId" value="Alice" />

        <div class="btn-group">
            <button class="btn-join" onclick="joinGame('white')">Join as White</button>
            <button class="btn-join" onclick="joinGame('black')">Join as Black</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;" />

        <h3>2. Make a Move</h3>
        <label>Chess Move (e.g., e2e4):</label>
        <input type="text" id="move" placeholder="e2e4" />

        <div class="btn-group">
            <button class="btn-move" onclick="sendMove()">Submit Move</button>
        </div>
    </div>

    <h3>Server Response:</h3>
    <div id="log">Waiting for action...</div>

    <h3>Current Board (FEN):</h3>
    <code id="fenDisplay">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</code>

    <script>
        var pollId = null;
        async function joinGame(color) {
            const gameId = document.getElementById('gameId').value;
            const playerId = document.getElementById('playerId').value;
            const log = document.getElementById('log');

            try {
                const response = await fetch('/api/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId, playerId, color })
                });
                const result = await response.json();
                log.innerText = result.message;
                startPolling();
            } catch (err) {
                log.innerText = "Error: " + err.message;
            }
        }
        function startPolling() {
        // Safety: Stop any existing timer before starting a new one
            if (pollId) clearInterval(pollId);
        
            // Start the loop and save the ID
            pollId = setInterval(refreshGame, 1000);
            console.log("Polling started...");
        }
        async function sendMove() {
            const gameId = document.getElementById('gameId').value;
            const playerId = document.getElementById('playerId').value;
            const move = document.getElementById('move').value;
            const fenDisplay = document.getElementById('fenDisplay');

            try {
                const response = await fetch('/api/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId, playerId, move })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert( "✅ " + result.message);
                    fenDisplay.innerText = result.fen;
                } else {
                    alert( "❌ " + result.message);
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }


    // Polling Function
    async function refreshGame() {
        const gameId = document.getElementById('gameId').value;
        const fenDisplay = document.getElementById('fenDisplay');

        if (!gameId) return;

        try {
            const res = await fetch(`/api/game/${gameId}`);
            if (res.ok) {
                const data = await res.json();
                
                // Check against global state
                if (data.fen && data.fen !== fenDisplay.value) {
                    fenDisplay.value = data.fen; // Update global state
                    
                    document.getElementById('fenDisplay').innerText = data.fen;
                    
                }
                document.getElementById('log').innerText = data.message;
                if (data.result && data.result !== "") {
                     clearInterval(pollId);
                     pollId = null;
                }

            }
        } catch (err) {
            console.error("Polling error:", err);
        }
    }

    // Run every 1 second
    </script>
</body>
</html>