<!DOCTYPE html>
<html>
<head>
    <title>F# Chess Server</title>
    <link rel="stylesheet" href="main.css" /></head>
<body>
    <h1>F# Chess Server</h1>

    <div class="box">
        <h3>1. Join a Game</h3>
        <label>Game ID:</label>
        <input type="text" id="gameId" value="GameRoom1" />



        <div class="btn-group">
            <button class="btn-join" onclick="joinGame('white')">Join as White</button>
            <button class="btn-join" onclick="joinGame('black')">Join as Black</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;" />

        <h3>2. Make a Move</h3>
        <label>Chess Move (e.g., e2e4):</label>
        <input type="text" id="move" placeholder="e2e4" />

        <div class="btn-group">
            <button class="btn-move" onclick="sendMove()">Submit Move</button>
        </div>
    </div>

    <h3>Server Response:</h3>
    <div id="log">Waiting for action...</div>

    <h3>Current Board (FEN):</h3>
    <code id="fenDisplay">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</code>

    <script>
        const playerId = localStorage.getItem("chessPlayerName");
            if (playerId===null) {
                window.location.href = "/login"; 
            }
        var pollId = null;
        async function joinGame(color) {
            const gameId = document.getElementById('gameId').value;

            try {
                const response = await fetch('/api/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId, playerId, color })
                });
                const result = await response.json();
                alert(result.message);
                startPolling();
            } catch (err) {
                log.innerText = "Error: " + err.message;
            }
        }
        function startPolling() {
            if (pollId) clearInterval(pollId);
            //changed polling to 2s to save on server time
            pollId = setInterval(refreshGame, 2000);
            console.log("Polling started...");
        }
        async function sendMove() {
            const gameId = document.getElementById('gameId').value;
            const move = document.getElementById('move').value;
            const fenDisplay = document.getElementById('fenDisplay');

            try {
                const response = await fetch('/api/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId, playerId, move })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert( "✅ " + result.message);
                    fenDisplay.innerText = result.fen;
                } else {
                    alert( "❌ " + result.message);
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }


    async function refreshGame() {
        const gameId = document.getElementById('gameId').value;
        const fenDisplay = document.getElementById('fenDisplay');

        if (!gameId) return;

        try {
            const res = await fetch(`/api/game/${gameId}`);
            if (res.ok) {
                const data = await res.json();
                
                // Check against global state
                if (data.fen && data.fen !== fenDisplay.value) {
                    fenDisplay.value = data.fen; // Update global state
                    
                    document.getElementById('fenDisplay').innerText = data.fen;
                    
                }
                document.getElementById('log').innerText = data.message;
                if (data.result && data.result !== "") {
                     clearInterval(pollId);
                     pollId = null;
                }

            }
        } catch (err) {
            console.error("Polling error:", err);
        }
    }

    </script>
</body>
</html>